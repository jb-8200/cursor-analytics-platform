# P0: Make Repo Runnable in 1â€“2 Hours

## Goal
After completing P0, a developer should be able to:
```bash
docker-compose up
# ... wait 30 seconds ...
# Simulator is running on http://localhost:8080
# Core service on http://localhost:4000 (GraphQL + REST)
# Dashboard on http://localhost:3000
# Sample data flows: sim â†’ core â†’ viz
```

---

## P0 Scope (8 Concrete Tasks)

### Task P0.1: cursor-sim Go Scaffolding
**Time**: 15 min
**Outcome**: `docker-sim` can compile and start

**Files to Create**:

**`services/cursor-sim/go.mod`**:
```go
module github.com/anthropics/cursor-analytics-platform/services/cursor-sim

go 1.21

require (
    github.com/gorilla/mux v1.8.0
    github.com/joho/godotenv v1.5.1
)
```

**`services/cursor-sim/go.sum`** (auto-generated by `go mod tidy`)

**`services/cursor-sim/cmd/server/main.go`**:
```go
package main

import (
    "context"
    "fmt"
    "log"
    "net/http"
    "os"
    "os/signal"
    "syscall"
    "time"

    "github.com/gorilla/mux"
    "github.com/joho/godotenv"
)

func main() {
    // Load .env
    _ = godotenv.Load()

    port := os.Getenv("CURSOR_SIM_PORT")
    if port == "" {
        port = "8080"
    }

    router := mux.NewRouter()

    // Health check
    router.HandleFunc("/health", func(w http.ResponseWriter, r *http.Request) {
        w.Header().Set("Content-Type", "application/json")
        w.WriteHeader(http.StatusOK)
        fmt.Fprintf(w, `{"status":"ok","service":"cursor-sim"}`)
    }).Methods("GET")

    // Stub endpoints (match Cursor API shapes)
    router.HandleFunc("/v1/teams/members", func(w http.ResponseWriter, r *http.Request) {
        w.Header().Set("Content-Type", "application/json")
        fmt.Fprintf(w, `{"data":[]}`)
    }).Methods("GET")

    router.HandleFunc("/v1/analytics/ai-code/commits", func(w http.ResponseWriter, r *http.Request) {
        w.Header().Set("Content-Type", "application/json")
        fmt.Fprintf(w, `{"data":[],"pagination":{"page":1,"pageSize":100,"total":0}}`)
    }).Methods("GET")

    server := &http.Server{
        Addr:    ":" + port,
        Handler: router,
    }

    // Graceful shutdown
    go func() {
        sigChan := make(chan os.Signal, 1)
        signal.Notify(sigChan, syscall.SIGINT, syscall.SIGTERM)
        <-sigChan
        log.Println("Shutting down cursor-sim...")
        ctx, cancel := context.WithTimeout(context.Background(), 5*time.Second)
        defer cancel()
        server.Shutdown(ctx)
    }()

    log.Printf("cursor-sim listening on http://0.0.0.0:%s", port)
    if err := server.ListenAndServe(); err != nil && err != http.ErrServerClosed {
        log.Fatalf("Server error: %v", err)
    }
}
```

**`services/cursor-sim/.dockerignore`**:
```
.git
.github
.env.local
*.test
*.out
vendor
```

---

### Task P0.2: cursor-analytics-core TypeScript Scaffolding
**Time**: 20 min
**Outcome**: `docker build` works for core, Apollo server starts

**Files to Create**:

**`services/cursor-analytics-core/package.json`**:
```json
{
  "name": "cursor-analytics-core",
  "version": "0.1.0",
  "type": "module",
  "scripts": {
    "dev": "tsx watch src/index.ts",
    "build": "tsc",
    "start": "node dist/index.js",
    "test": "vitest",
    "codegen": "graphql-code-generator"
  },
  "dependencies": {
    "@apollo/server": "^4.9.0",
    "express": "^4.18.2",
    "graphql": "^16.8.0",
    "pg": "^8.11.0"
  },
  "devDependencies": {
    "@types/express": "^4.17.20",
    "@types/node": "^20.8.0",
    "typescript": "^5.3.0",
    "tsx": "^4.1.0",
    "vitest": "^0.34.0"
  }
}
```

**`services/cursor-analytics-core/tsconfig.json`**:
```json
{
  "compilerOptions": {
    "target": "ES2020",
    "module": "ES2020",
    "lib": ["ES2020"],
    "outDir": "./dist",
    "rootDir": "./src",
    "strict": true,
    "esModuleInterop": true,
    "skipLibCheck": true,
    "forceConsistentCasingInFileNames": true
  },
  "include": ["src"],
  "exclude": ["node_modules"]
}
```

**`services/cursor-analytics-core/src/index.ts`**:
```typescript
import { ApolloServer } from "@apollo/server";
import { startStandaloneServer } from "@apollo/server/standalone";
import express from "express";

const typeDefs = `
  type Query {
    health: String
    developers(limit: Int): [Developer]
  }

  type Developer {
    id: String
    email: String
  }
`;

const resolvers = {
  Query: {
    health: () => "ok",
    developers: () => [],
  },
};

async function start() {
  const server = new ApolloServer({ typeDefs, resolvers });

  const { url } = await startStandaloneServer(server, {
    listen: { port: 4000 },
  });

  console.log(`ðŸš€ cursor-analytics-core ready at ${url}`);
}

start().catch(console.error);
```

**`services/cursor-analytics-core/.dockerignore`**:
```
node_modules
dist
.env.local
*.test
coverage
.git
```

---

### Task P0.3: cursor-viz-spa React + Vite Scaffolding
**Time**: 20 min
**Outcome**: React app with Vite builds and runs

**Files to Create**:

**`services/cursor-viz-spa/package.json`**:
```json
{
  "name": "cursor-viz-spa",
  "version": "0.1.0",
  "type": "module",
  "scripts": {
    "dev": "vite",
    "build": "tsc && vite build",
    "preview": "vite preview",
    "test": "vitest"
  },
  "dependencies": {
    "react": "^18.2.0",
    "react-dom": "^18.2.0",
    "recharts": "^2.10.0"
  },
  "devDependencies": {
    "@types/react": "^18.2.0",
    "@types/react-dom": "^18.2.0",
    "@vitejs/plugin-react": "^4.1.0",
    "typescript": "^5.3.0",
    "vite": "^5.0.0",
    "vitest": "^0.34.0"
  }
}
```

**`services/cursor-viz-spa/tsconfig.json`**:
```json
{
  "compilerOptions": {
    "target": "ES2020",
    "useDefineForClassFields": true,
    "lib": ["ES2020", "DOM", "DOM.Iterable"],
    "module": "ESNext",
    "skipLibCheck": true,
    "esModuleInterop": true,
    "allowSyntheticDefaultImports": true,
    "strict": true,
    "resolveJsonModule": true,
    "isolatedModules": true,
    "moduleResolution": "bundler",
    "noEmit": true,
    "jsx": "react-jsx"
  },
  "include": ["src"],
  "references": [{ "path": "./tsconfig.node.json" }]
}
```

**`services/cursor-viz-spa/vite.config.ts`**:
```typescript
import { defineConfig } from "vite";
import react from "@vitejs/plugin-react";

export default defineConfig({
  plugins: [react()],
  server: {
    port: 3000,
    proxy: {
      "/graphql": {
        target: "http://localhost:4000",
        changeOrigin: true,
      },
    },
  },
});
```

**`services/cursor-viz-spa/index.html`**:
```html
<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Cursor Analytics Dashboard</title>
  </head>
  <body>
    <div id="root"></div>
    <script type="module" src="/src/main.tsx"></script>
  </body>
</html>
```

**`services/cursor-viz-spa/src/main.tsx`**:
```typescript
import React from "react";
import ReactDOM from "react-dom/client";
import App from "./App";

ReactDOM.createRoot(document.getElementById("root")!).render(
  <React.StrictMode>
    <App />
  </React.StrictMode>
);
```

**`services/cursor-viz-spa/src/App.tsx`**:
```typescript
import { useEffect, useState } from "react";

export default function App() {
  const [health, setHealth] = useState<string>("connecting...");

  useEffect(() => {
    const query = `query { health }`;
    fetch("/graphql", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ query }),
    })
      .then((res) => res.json())
      .then((data) => setHealth(data.data?.health || "error"))
      .catch((err) => setHealth(`error: ${err.message}`));
  }, []);

  return (
    <div style={{ padding: "20px", fontFamily: "sans-serif" }}>
      <h1>Cursor Analytics Dashboard</h1>
      <p>
        Status: <strong>{health}</strong>
      </p>
      <p>Core service reachable on port 4000</p>
    </div>
  );
}
```

**`services/cursor-viz-spa/.dockerignore`**:
```
node_modules
dist
.env.local
*.test
coverage
.git
```

---

### Task P0.4: Add Dockerfiles (Multi-Stage Builds)
**Time**: 20 min

**`services/cursor-sim/Dockerfile`**:
```dockerfile
# Stage 1: Builder
FROM golang:1.21-alpine AS builder
WORKDIR /app
COPY go.mod go.sum ./
RUN go mod download
COPY . .
RUN CGO_ENABLED=0 GOOS=linux go build -a -installsuffix cgo \
    -o server ./cmd/server/main.go

# Stage 2: Runtime
FROM alpine:3.18
RUN apk add --no-cache ca-certificates
WORKDIR /app
COPY --from=builder /app/server .
EXPOSE 8080
CMD ["./server"]
```

**`services/cursor-analytics-core/Dockerfile`**:
```dockerfile
# Stage 1: Dependencies & Build
FROM node:20-alpine AS builder
WORKDIR /app
COPY package.json package-lock.json ./
RUN npm ci
COPY . .
RUN npm run build

# Stage 2: Runtime
FROM node:20-alpine
WORKDIR /app
COPY package.json package-lock.json ./
RUN npm ci --only=production
COPY --from=builder /app/dist ./dist
EXPOSE 4000
CMD ["npm", "start"]
```

**`services/cursor-viz-spa/Dockerfile`**:
```dockerfile
# Stage 1: Build
FROM node:20-alpine AS builder
WORKDIR /app
COPY package.json package-lock.json ./
RUN npm ci
COPY . .
RUN npm run build

# Stage 2: Serve with nginx
FROM nginx:alpine
COPY --from=builder /app/dist /usr/share/nginx/html
COPY nginx.conf /etc/nginx/conf.d/default.conf
EXPOSE 3000
CMD ["nginx", "-g", "daemon off;"]
```

**`services/cursor-viz-spa/nginx.conf`**:
```nginx
server {
    listen 3000;
    server_name localhost;

    root /usr/share/nginx/html;
    index index.html;

    location / {
        try_files $uri $uri/ /index.html;
    }

    location /graphql {
        proxy_pass http://cursor-analytics-core:4000;
        proxy_http_version 1.1;
        proxy_set_header Connection "";
    }
}
```

---

### Task P0.5: .env.example with Defaults
**Time**: 5 min

**`.env.example`**:
```bash
# cursor-sim (Simulator)
CURSOR_SIM_PORT=8080
CURSOR_SIM_DEVELOPERS=50
CURSOR_SIM_VELOCITY=medium
CURSOR_SIM_VOLATILITY=0.2
CURSOR_SIM_SEED=12345
CURSOR_SIM_BREAK_CONDITION=none
CURSOR_SIM_API_KEY=sim_test_key_12345
CURSOR_SIM_API_SECRET=sim_test_secret_67890

# cursor-analytics-core (Backend)
GRAPHQL_PORT=4000
DATABASE_URL=postgresql://postgres:password@postgres:5432/cursor_analytics
SIMULATOR_URL=http://cursor-sim:8080
POLL_INTERVAL_MS=60000

# cursor-viz-spa (Frontend)
VITE_GRAPHQL_URL=http://localhost:4000/graphql
VITE_SIMULATOR_URL=http://localhost:8080

# Shared
NODE_ENV=development
ENVIRONMENT=development
```

**Instructions**: Copy to `.env` before running `docker-compose up`:
```bash
cp .env.example .env
```

---

### Task P0.6: Update docker-compose.yml
**Time**: 10 min

**`docker-compose.yml`** (Replace existing):
```yaml
version: "3.9"

services:
  # PostgreSQL Database
  postgres:
    image: postgres:15-alpine
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: password
      POSTGRES_DB: cursor_analytics
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 5s
      timeout: 5s
      retries: 5

  # Simulator (Go)
  cursor-sim:
    build:
      context: ./services/cursor-sim
      dockerfile: Dockerfile
    ports:
      - "8080:8080"
    environment:
      CURSOR_SIM_PORT: "8080"
      CURSOR_SIM_DEVELOPERS: "50"
      CURSOR_SIM_VELOCITY: "medium"
      CURSOR_SIM_VOLATILITY: "0.2"
    depends_on:
      - postgres
    restart: unless-stopped

  # Analytics Core (TypeScript/Node)
  cursor-analytics-core:
    build:
      context: ./services/cursor-analytics-core
      dockerfile: Dockerfile
    ports:
      - "4000:4000"
    environment:
      GRAPHQL_PORT: "4000"
      DATABASE_URL: "postgresql://postgres:password@postgres:5432/cursor_analytics"
      SIMULATOR_URL: "http://cursor-sim:8080"
      POLL_INTERVAL_MS: "60000"
    depends_on:
      postgres:
        condition: service_healthy
      cursor-sim:
        condition: service_started
    restart: unless-stopped

  # Dashboard (React + Vite)
  cursor-viz-spa:
    build:
      context: ./services/cursor-viz-spa
      dockerfile: Dockerfile
    ports:
      - "3000:3000"
    environment:
      VITE_GRAPHQL_URL: "http://localhost:4000/graphql"
      VITE_SIMULATOR_URL: "http://localhost:8080"
    depends_on:
      - cursor-analytics-core
    restart: unless-stopped

volumes:
  postgres_data:
```

---

### Task P0.7: Update Makefile
**Time**: 10 min

**Add these targets to existing `Makefile`**:

```makefile
# P0 Quick-Start Targets
.PHONY: setup-p0
setup-p0: ## Setup for P0 (install Go, Node, Docker)
	@echo "Installing dependencies..."
	cd services/cursor-sim && go mod tidy
	cd services/cursor-analytics-core && npm install
	cd services/cursor-viz-spa && npm install
	cp .env.example .env
	@echo "âœ… Setup complete. Run: docker-compose up"

.PHONY: docker-build
docker-build: ## Build all Docker images
	docker-compose build

.PHONY: docker-up
docker-up: ## Start all services in Docker
	docker-compose up

.PHONY: docker-down
docker-down: ## Stop all services
	docker-compose down

.PHONY: docker-logs
docker-logs: ## Stream all service logs
	docker-compose logs -f

.PHONY: docker-logs-sim
docker-logs-sim: ## Stream simulator logs only
	docker-compose logs -f cursor-sim

.PHONY: docker-logs-core
docker-logs-core: ## Stream core service logs
	docker-compose logs -f cursor-analytics-core

.PHONY: docker-logs-viz
docker-logs-viz: ## Stream dashboard logs
	docker-compose logs -f cursor-viz-spa

# Local Development (without Docker)
.PHONY: dev-sim
dev-sim: ## Run simulator locally
	cd services/cursor-sim && go run ./cmd/server/main.go

.PHONY: dev-core
dev-core: ## Run analytics core locally
	cd services/cursor-analytics-core && npm run dev

.PHONY: dev-viz
dev-viz: ## Run dashboard locally
	cd services/cursor-viz-spa && npm run dev

.PHONY: test
test: ## Run all tests
	cd services/cursor-sim && go test ./...
	cd services/cursor-analytics-core && npm test
	cd services/cursor-viz-spa && npm test

.PHONY: clean
clean: ## Clean build artifacts
	cd services/cursor-sim && go clean
	cd services/cursor-analytics-core && rm -rf dist node_modules
	cd services/cursor-viz-spa && rm -rf dist node_modules
	docker-compose down --volumes
```

---

### Task P0.8: Happy Path â€” One Day of Data Flow
**Time**: 30 min

**Concept**: Simulator generates 1 day of synthetic data â†’ Core ingests â†’ Dashboard displays chart.

**`services/cursor-sim/cmd/server/main.go`** (Enhanced):
```go
// Add to handlers before server.ListenAndServe()

// Endpoint: POST /v1/simulate-day
// Generates 1 day of synthetic data
router.HandleFunc("/v1/simulate-day", func(w http.ResponseWriter, r *http.Request) {
    // For now, return mock data
    w.Header().Set("Content-Type", "application/json")
    data := map[string]interface{}{
        "date":       time.Now().Format("2006-01-02"),
        "developers": 50,
        "commits":    347,
        "dau":        48,
    }
    w.WriteHeader(http.StatusOK)
    json.NewEncoder(w).Encode(data)
}).Methods("POST")

// Endpoint: GET /v1/analytics/daily-usage
// Returns daily usage metrics
router.HandleFunc("/v1/analytics/daily-usage", func(w http.ResponseWriter, r *http.Request) {
    w.Header().Set("Content-Type", "application/json")
    response := map[string]interface{}{
        "data": []map[string]interface{}{
            {
                "date":        time.Now().Format("2006-01-02"),
                "dau":         48,
                "commits":     347,
                "agent_edits": 256,
            },
        },
        "pagination": map[string]int{
            "page":      1,
            "pageSize":  100,
            "total":     1,
        },
    }
    w.WriteHeader(http.StatusOK)
    json.NewEncoder(w).Encode(response)
}).Methods("GET")
```

**`services/cursor-analytics-core/src/index.ts`** (Enhanced):
```typescript
// Add GraphQL types and resolvers
const typeDefs = `
  type Query {
    health: String
    dailyUsage(date: String): [DailyMetric]
  }

  type DailyMetric {
    date: String
    dau: Int
    commits: Int
    agentEdits: Int
  }
`;

const resolvers = {
  Query: {
    health: () => "ok",
    dailyUsage: async (_, { date }) => {
      // Fetch from simulator
      const response = await fetch("http://localhost:8080/v1/analytics/daily-usage");
      const json = await response.json();
      return json.data;
    },
  },
};
```

**`services/cursor-viz-spa/src/App.tsx`** (Enhanced with Chart):
```typescript
import { useEffect, useState } from "react";
import { LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer } from "recharts";

interface DailyMetric {
  date: string;
  dau: number;
  commits: number;
  agentEdits: number;
}

export default function App() {
  const [metrics, setMetrics] = useState<DailyMetric[]>([]);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    const query = `query { dailyUsage(date: null) { date dau commits agentEdits } }`;
    fetch("/graphql", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ query }),
    })
      .then((res) => res.json())
      .then((data) => {
        setMetrics(data.data?.dailyUsage || []);
        setLoading(false);
      })
      .catch((err) => {
        console.error(err);
        setLoading(false);
      });
  }, []);

  return (
    <div style={{ padding: "20px", fontFamily: "sans-serif" }}>
      <h1>Cursor Analytics Dashboard</h1>
      {loading ? (
        <p>Loading...</p>
      ) : metrics.length > 0 ? (
        <ResponsiveContainer width="100%" height={400}>
          <LineChart data={metrics}>
            <CartesianGrid strokeDasharray="3 3" />
            <XAxis dataKey="date" />
            <YAxis />
            <Tooltip />
            <Legend />
            <Line type="monotone" dataKey="dau" stroke="#8884d8" />
            <Line type="monotone" dataKey="commits" stroke="#82ca9d" />
            <Line type="monotone" dataKey="agentEdits" stroke="#ffc658" />
          </LineChart>
        </ResponsiveContainer>
      ) : (
        <p>No data available. Run /v1/simulate-day on the simulator to generate data.</p>
      )}
    </div>
  );
}
```

---

## Verification Checklist (P0 Complete)

Run through this after all 8 tasks:

```bash
# 1. Clone .env
cp .env.example .env

# 2. Build all services
docker-compose build

# 3. Start services
docker-compose up

# 4. Verify health endpoints
curl http://localhost:8080/health
# Expected: {"status":"ok","service":"cursor-sim"}

curl http://localhost:4000/graphql
# Expected: GraphQL endpoint available

# 5. Visit dashboard
open http://localhost:3000
# Expected: "Cursor Analytics Dashboard" page loads

# 6. Trigger simulator
curl -X POST http://localhost:8080/v1/simulate-day
# Expected: {"date":"2024-01-15","developers":50,"commits":347,"dau":48}

# 7. Query GraphQL
curl -X POST http://localhost:4000/graphql \
  -H "Content-Type: application/json" \
  -d '{"query":"{ health }"}'
# Expected: {"data":{"health":"ok"}}

# 8. Dashboard chart should update
# Open browser console, should see data flow from sim â†’ core â†’ viz
```

---

## What This Enables

After P0:

âœ… **Runnable**: `docker-compose up` works
âœ… **Testable**: Each service has a health endpoint
âœ… **Extensible**: All scaffolding in place for data generation
âœ… **Contract-ready**: Ready for P1 (add OpenAPI schemas and type generation)
âœ… **Dev-friendly**: `make dev-sim`, `make dev-core`, `make dev-viz` for local development

---

## P1 Readiness

After P0 is complete, you'll tackle:

1. **Contract Layer** (`packages/shared-schemas/`):
   - `cursor-admin.openapi.yaml` (simulator endpoints)
   - `cursor-analytics.openapi.yaml` (Cursor-compatible API shapes)
   - Type generation for TS and Go

2. **Cursor-Compatible Simulator**:
   - `/v1/teams/members`
   - `/v1/analytics/ai-code/commits`
   - `/v1/analytics/team/agent-edits`
   - etc.

3. **Production-Grade Ingestion**:
   - Incremental polling (persist last_polled_hour)
   - Idempotent storage (raw_usage_events + aggregates)
   - Rate limit handling (429)

4. **Database Migrations**:
   - Dimensional schema (dim_user, fact_usage_hourly)
   - Initial migration files for schema setup

---

## Time Estimate

| Task | Time |
|------|------|
| P0.1 (cursor-sim Go) | 15 min |
| P0.2 (cursor-analytics-core TS) | 20 min |
| P0.3 (cursor-viz-spa React) | 20 min |
| P0.4 (Dockerfiles) | 20 min |
| P0.5 (.env.example) | 5 min |
| P0.6 (docker-compose.yml) | 10 min |
| P0.7 (Makefile) | 10 min |
| P0.8 (Happy path: sim â†’ core â†’ viz) | 30 min |
| **Total** | **130 min (2 hrs)** |

---

**Next step**: Shall I proceed with implementing all 8 tasks?

