# Design Document: GraphQL Code Generator Setup

**Feature ID**: P6-F02
**Epic**: P6 - cursor-viz-spa (Service Decoupling Phase 1)
**Created**: January 4, 2026
**Status**: PROPOSED

---

## Overview

Implement GraphQL Code Generator in cursor-viz-spa to auto-generate TypeScript types from cursor-analytics-core's GraphQL schema, eliminating manual type definitions and preventing schema drift.

---

## Architecture

### Before (Current - Manual Types)

```
┌─────────────────────────────────┐       ┌─────────────────────────────────┐
│  cursor-analytics-core (P5)     │       │  cursor-viz-spa (P6)            │
│  ─────────────────────────────  │       │  ─────────────────────────────  │
│                                 │       │                                 │
│  src/graphql/schema.ts          │       │  src/graphql/types.ts           │
│  ┌───────────────────────────┐  │       │  ┌───────────────────────────┐  │
│  │ type TeamStats {          │  │       │  │ interface TeamStats {     │  │
│  │   topPerformer: Developer │  │  ❌   │  │   topPerformers: Dev[]    │  │
│  │ }                         │  │       │  │ }                         │  │
│  └───────────────────────────┘  │       │  └───────────────────────────┘  │
│                                 │       │                                 │
│  (Source of Truth)              │       │  (Manual, DRIFTS)               │
└─────────────────────────────────┘       └─────────────────────────────────┘
                                                       │
                                                       ▼
                                          Runtime Error! 400 Bad Request
```

### After (Target - Generated Types)

```
┌─────────────────────────────────────────────────────────────────────────────┐
│  cursor-analytics-core (P5)                                                 │
│  ─────────────────────────────────────────────────────────────────────────  │
│  src/graphql/schema.ts (Source of Truth)                                   │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │ type TeamStats { topPerformer: Developer }                            │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
│                                                                             │
│  http://localhost:4000/graphql (GraphQL Endpoint)                          │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    │ npm run codegen (introspection query)
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  cursor-viz-spa (P6)                                                        │
│  ─────────────────────────────────────────────────────────────────────────  │
│                                                                             │
│  src/graphql/generated.ts (AUTO-GENERATED)                                 │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │ // Generated by GraphQL Code Generator - DO NOT EDIT                  │  │
│  │ export interface TeamStats {                                          │  │
│  │   topPerformer?: Developer;  // Matches P5 ✅                          │  │
│  │ }                                                                     │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
│                                                                             │
│  src/graphql/queries.ts                                                    │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │ import { TeamStats } from './generated';                              │  │
│  │ // TypeScript validates against REAL P5 schema ✅                      │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
                     Compile-Time Error! (not runtime)
```

---

## Implementation Details

### 1. Dependencies

```json
{
  "devDependencies": {
    "@graphql-codegen/cli": "^5.0.0",
    "@graphql-codegen/typescript": "^4.0.0",
    "@graphql-codegen/typescript-operations": "^4.0.0",
    "@graphql-codegen/typed-document-node": "^5.0.0"
  }
}
```

### 2. Configuration File

**File**: `services/cursor-viz-spa/codegen.yml`

```yaml
overwrite: true
schema: "http://localhost:4000/graphql"
documents: "src/**/*.{ts,tsx}"
generates:
  src/graphql/generated.ts:
    plugins:
      - "typescript"
      - "typescript-operations"
      - "typed-document-node"
    config:
      avoidOptionals: false
      maybeValue: T | null | undefined
      inputMaybeValue: T | null | undefined
      scalars:
        DateTime: string
        Date: string
      enumsAsTypes: true
      skipTypename: false
```

### 3. NPM Scripts

```json
{
  "scripts": {
    "codegen": "graphql-codegen --config codegen.yml",
    "codegen:watch": "graphql-codegen --watch --config codegen.yml",
    "predev": "npm run codegen",
    "prebuild": "npm run codegen"
  }
}
```

### 4. Generated File Structure

```typescript
// src/graphql/generated.ts

// Scalars
export type Scalars = {
  ID: string;
  String: string;
  Boolean: boolean;
  Int: number;
  Float: number;
  DateTime: string;
};

// Types (from P5 schema)
export interface Developer {
  id: Scalars['ID'];
  externalId: Scalars['String'];
  name: Scalars['String'];
  email: Scalars['String'];
  team?: Scalars['String'] | null;
  seniority: Scalars['String'];
  stats?: DeveloperStats | null;
}

export interface TeamStats {
  teamName: Scalars['String'];
  memberCount: Scalars['Int'];
  topPerformer?: Developer | null;  // Generated correctly!
  avgAcceptanceRate: Scalars['Float'];
  totalCommits: Scalars['Int'];
}

// Query Types
export type GetDashboardSummaryQuery = {
  dashboardSummary: {
    totalDevelopers: number;
    teamComparison: TeamStats[];
    // ... etc
  };
};

// Typed Document Nodes (for Apollo Client)
export const GetDashboardSummaryDocument = gql`
  query GetDashboardSummary { ... }
`;
```

### 5. Usage in Components

**Before** (manual types):
```typescript
// src/graphql/queries.ts
import { TeamStats } from './types';  // ❌ Manual, drifts

const GET_DASHBOARD = gql`
  query GetDashboard {
    dashboardSummary {
      teamComparison {
        topPerformers { name }  // ❌ Wrong field name!
      }
    }
  }
`;
```

**After** (generated types):
```typescript
// src/graphql/queries.ts
import { GetDashboardSummaryDocument, GetDashboardSummaryQuery } from './generated';

// TypeScript error: Property 'topPerformers' does not exist
// Did you mean 'topPerformer'?
```

---

## Migration Path

### Step 1: Install Dependencies
```bash
cd services/cursor-viz-spa
npm install -D @graphql-codegen/cli @graphql-codegen/typescript \
  @graphql-codegen/typescript-operations @graphql-codegen/typed-document-node
```

### Step 2: Create codegen.yml
- Configure schema endpoint
- Configure output path
- Configure plugins

### Step 3: Generate Initial Types
```bash
# Ensure P5 is running
cd ../cursor-analytics-core && npm run dev &
cd ../cursor-viz-spa && npm run codegen
```

### Step 4: Update Imports
- Search for imports from `./types` or `../types`
- Replace with imports from `./generated`
- Fix any TypeScript errors (these are real schema mismatches!)

### Step 5: Delete Manual Types
```bash
rm src/graphql/types.ts
```

### Step 6: Add Hooks
- Add predev and prebuild scripts
- Test `npm run dev` and `npm run build`

### Step 7: Add CI Validation
- Ensure generated.ts is committed
- CI fails if regeneration produces different output

---

## CI/CD Integration

### GitHub Actions Validation

```yaml
# .github/workflows/schema-validation.yml
- name: Validate Generated Types
  run: |
    cd services/cursor-viz-spa
    npm run codegen
    git diff --exit-code src/graphql/generated.ts || {
      echo "❌ Generated types have changed!"
      echo "Run: npm run codegen && git add src/graphql/generated.ts"
      exit 1
    }
```

---

## Error Handling

### P5 Not Running
```
Error: connect ECONNREFUSED 127.0.0.1:4000
Solution: Start P5 with `cd services/cursor-analytics-core && npm run dev`
```

### Schema Changed
```
TypeScript Error: Property 'X' does not exist on type 'Y'
Solution: This is intentional! Fix your queries to match the new schema.
```

---

## Rollback Plan

If code generator causes issues:
1. Revert codegen.yml and package.json changes
2. Restore src/graphql/types.ts from git
3. Update imports back to types.ts

---

## Success Metrics

| Metric | Before | After |
|--------|--------|-------|
| Schema mismatches discovered | Runtime (browser 400) | Compile-time (IDE) |
| Manual type sync required | Every P5 change | Never |
| Type safety coverage | Local types only | Full schema |
| Developer experience | Manual, error-prone | Automated, safe |

---

## References

- [GraphQL Code Generator Documentation](https://the-guild.dev/graphql/codegen)
- [typed-document-node Plugin](https://the-guild.dev/graphql/codegen/plugins/typescript/typed-document-node)
- `docs/data-contract-testing.md` (Phase 1 implementation)
